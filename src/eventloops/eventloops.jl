module EventLoops

# Reseau's libuv-free event loop surface.
#
# This module houses the native event-loop implementations (kqueue/epoll/iocp),
# along with the core IO definitions that the socket stack builds upon.

using EnumX
using ScopedValues: ScopedValue, @with

using ..Reseau:
    ByteBuffer,
    ClockSource,
    ERROR_ENUM_BEGIN_RANGE,
    ERROR_ENUM_END_RANGE,
    ERROR_INVALID_ARGUMENT,
    ERROR_INVALID_FILE_HANDLE,
    ERROR_INVALID_STATE,
    ERROR_PLATFORM_NOT_SUPPORTED,
    ERROR_SYS_CALL_FAILURE,
    ERROR_THREAD_NO_SUCH_THREAD_ID,
    EventCallable,
    LOG_SUBJECT_BEGIN_RANGE,
    LOG_SUBJECT_END_RANGE,
    LogLevel,
    LogSubject,
    LogSubjectInfo,
    ReseauError,
    ScheduledTask,
    SequenceClock,
    TIMESTAMP_NANOS,
    TaskFn,
    TaskScheduler,
    TaskStatus,
    _coerce_task_status,
    _fcntl,
    _log_subject_registry,
    add_u64_saturating,
    capacity,
    clock_now_ns,
    high_res_clock_get_ticks,
    logf,
    raise_error,
    RefClock,
    HighResClock,
    task_run!,
    task_scheduler_cancel!,
    task_scheduler_clean_up!,
    task_scheduler_has_tasks,
    task_scheduler_run_all!,
    task_scheduler_schedule_future!,
    task_scheduler_schedule_now!,
    thread_sleep_ns,
    throw_error,

    IO_PACKAGE_ID,
    ERROR_IO_CHANNEL_ERROR_CANT_ACCEPT_INPUT,
    ERROR_IO_CHANNEL_UNKNOWN_MESSAGE_TYPE,
    ERROR_IO_CHANNEL_READ_WOULD_EXCEED_WINDOW,
    ERROR_IO_EVENT_LOOP_ALREADY_ASSIGNED,
    ERROR_IO_EVENT_LOOP_SHUTDOWN,
    ERROR_IO_TLS_ERROR_NEGOTIATION_FAILURE,
    ERROR_IO_TLS_ERROR_NOT_NEGOTIATED,
    ERROR_IO_TLS_ERROR_WRITE_FAILURE,
    ERROR_IO_TLS_ERROR_ALERT_RECEIVED,
    ERROR_IO_TLS_CTX_ERROR,
    ERROR_IO_TLS_VERSION_UNSUPPORTED,
    ERROR_IO_TLS_CIPHER_PREF_UNSUPPORTED,
    ERROR_IO_MISSING_ALPN_MESSAGE,
    ERROR_IO_UNHANDLED_ALPN_PROTOCOL_MESSAGE,
    ERROR_IO_FILE_VALIDATION_FAILURE,
    ERROR_IO_EVENT_LOOP_THREAD_ONLY,
    ERROR_IO_ALREADY_SUBSCRIBED,
    ERROR_IO_NOT_SUBSCRIBED,
    ERROR_IO_OPERATION_CANCELLED,
    ERROR_IO_READ_WOULD_BLOCK,
    ERROR_IO_BROKEN_PIPE,
    ERROR_IO_SOCKET_UNSUPPORTED_ADDRESS_FAMILY,
    ERROR_IO_SOCKET_INVALID_OPERATION_FOR_TYPE,
    ERROR_IO_SOCKET_CONNECTION_REFUSED,
    ERROR_IO_SOCKET_TIMEOUT,
    ERROR_IO_SOCKET_NO_ROUTE_TO_HOST,
    ERROR_IO_SOCKET_NETWORK_DOWN,
    ERROR_IO_SOCKET_CLOSED,
    ERROR_IO_SOCKET_NOT_CONNECTED,
    ERROR_IO_SOCKET_INVALID_OPTIONS,
    ERROR_IO_SOCKET_ADDRESS_IN_USE,
    ERROR_IO_SOCKET_INVALID_ADDRESS,
    ERROR_IO_SOCKET_ILLEGAL_OPERATION_FOR_STATE,
    ERROR_IO_SOCKET_CONNECT_ABORTED,
    ERROR_IO_DNS_QUERY_FAILED,
    ERROR_IO_DNS_INVALID_NAME,
    ERROR_IO_DNS_NO_ADDRESS_FOR_HOST,
    ERROR_IO_DNS_HOST_REMOVED_FROM_CACHE,
    ERROR_IO_STREAM_INVALID_SEEK_POSITION,
    ERROR_IO_STREAM_READ_FAILED,
    ERROR_IO_INVALID_FILE_HANDLE_DEPRECATED,
    ERROR_IO_SHARED_LIBRARY_LOAD_FAILURE,
    ERROR_IO_SHARED_LIBRARY_FIND_SYMBOL_FAILURE,
    ERROR_IO_TLS_NEGOTIATION_TIMEOUT,
    ERROR_IO_TLS_ALERT_NOT_GRACEFUL,
    ERROR_IO_MAX_RETRIES_EXCEEDED,
    ERROR_IO_RETRY_PERMISSION_DENIED,
    ERROR_IO_TLS_DIGEST_ALGORITHM_UNSUPPORTED,
    ERROR_IO_TLS_SIGNATURE_ALGORITHM_UNSUPPORTED,
    ERROR_IO_PKCS11_VERSION_UNSUPPORTED,
    ERROR_IO_PKCS11_TOKEN_NOT_FOUND,
    ERROR_IO_PKCS11_KEY_NOT_FOUND,
    ERROR_IO_PKCS11_KEY_TYPE_UNSUPPORTED,
    ERROR_IO_PKCS11_UNKNOWN_CRYPTOKI_RETURN_VALUE,
    ERROR_IO_PKCS11_CKR_CANCEL,
    ERROR_IO_PKCS11_CKR_HOST_MEMORY,
    ERROR_IO_PKCS11_CKR_SLOT_ID_INVALID,
    ERROR_IO_PKCS11_CKR_GENERAL_ERROR,
    ERROR_IO_PKCS11_CKR_FUNCTION_FAILED,
    ERROR_IO_PKCS11_CKR_ARGUMENTS_BAD,
    ERROR_IO_PKCS11_CKR_NO_EVENT,
    ERROR_IO_PKCS11_CKR_NEED_TO_CREATE_THREADS,
    ERROR_IO_PKCS11_CKR_CANT_LOCK,
    ERROR_IO_PKCS11_CKR_ATTRIBUTE_READ_ONLY,
    ERROR_IO_PKCS11_CKR_ATTRIBUTE_SENSITIVE,
    ERROR_IO_PKCS11_CKR_ATTRIBUTE_TYPE_INVALID,
    ERROR_IO_PKCS11_CKR_ATTRIBUTE_VALUE_INVALID,
    ERROR_IO_PKCS11_CKR_ACTION_PROHIBITED,
    ERROR_IO_PKCS11_CKR_DATA_INVALID,
    ERROR_IO_PKCS11_CKR_DATA_LEN_RANGE,
    ERROR_IO_PKCS11_CKR_DEVICE_ERROR,
    ERROR_IO_PKCS11_CKR_DEVICE_MEMORY,
    ERROR_IO_PKCS11_CKR_DEVICE_REMOVED,
    ERROR_IO_PKCS11_CKR_ENCRYPTED_DATA_INVALID,
    ERROR_IO_PKCS11_CKR_ENCRYPTED_DATA_LEN_RANGE,
    ERROR_IO_PKCS11_CKR_FUNCTION_CANCELED,
    ERROR_IO_PKCS11_CKR_FUNCTION_NOT_PARALLEL,
    ERROR_IO_PKCS11_CKR_FUNCTION_NOT_SUPPORTED,
    ERROR_IO_PKCS11_CKR_KEY_HANDLE_INVALID,
    ERROR_IO_PKCS11_CKR_KEY_SIZE_RANGE,
    ERROR_IO_PKCS11_CKR_KEY_TYPE_INCONSISTENT,
    ERROR_IO_PKCS11_CKR_KEY_NOT_NEEDED,
    ERROR_IO_PKCS11_CKR_KEY_CHANGED,
    ERROR_IO_PKCS11_CKR_KEY_NEEDED,
    ERROR_IO_PKCS11_CKR_KEY_INDIGESTIBLE,
    ERROR_IO_PKCS11_CKR_KEY_FUNCTION_NOT_PERMITTED,
    ERROR_IO_PKCS11_CKR_KEY_NOT_WRAPPABLE,
    ERROR_IO_PKCS11_CKR_KEY_UNEXTRACTABLE,
    ERROR_IO_PKCS11_CKR_MECHANISM_INVALID,
    ERROR_IO_PKCS11_CKR_MECHANISM_PARAM_INVALID,
    ERROR_IO_PKCS11_CKR_OBJECT_HANDLE_INVALID,
    ERROR_IO_PKCS11_CKR_OPERATION_ACTIVE,
    ERROR_IO_PKCS11_CKR_OPERATION_NOT_INITIALIZED,
    ERROR_IO_PKCS11_CKR_PIN_INCORRECT,
    ERROR_IO_PKCS11_CKR_PIN_INVALID,
    ERROR_IO_PKCS11_CKR_PIN_LEN_RANGE,
    ERROR_IO_PKCS11_CKR_PIN_EXPIRED,
    ERROR_IO_PKCS11_CKR_PIN_LOCKED,
    ERROR_IO_PKCS11_CKR_SESSION_CLOSED,
    ERROR_IO_PKCS11_CKR_SESSION_COUNT,
    ERROR_IO_PKCS11_CKR_SESSION_HANDLE_INVALID,
    ERROR_IO_PKCS11_CKR_SESSION_PARALLEL_NOT_SUPPORTED,
    ERROR_IO_PKCS11_CKR_SESSION_READ_ONLY,
    ERROR_IO_PKCS11_CKR_SESSION_EXISTS,
    ERROR_IO_PKCS11_CKR_SESSION_READ_ONLY_EXISTS,
    ERROR_IO_PKCS11_CKR_SESSION_READ_WRITE_SO_EXISTS,
    ERROR_IO_PKCS11_CKR_SIGNATURE_INVALID,
    ERROR_IO_PKCS11_CKR_SIGNATURE_LEN_RANGE,
    ERROR_IO_PKCS11_CKR_TEMPLATE_INCOMPLETE,
    ERROR_IO_PKCS11_CKR_TEMPLATE_INCONSISTENT,
    ERROR_IO_PKCS11_CKR_TOKEN_NOT_PRESENT,
    ERROR_IO_PKCS11_CKR_TOKEN_NOT_RECOGNIZED,
    ERROR_IO_PKCS11_CKR_TOKEN_WRITE_PROTECTED,
    ERROR_IO_PKCS11_CKR_UNWRAPPING_KEY_HANDLE_INVALID,
    ERROR_IO_PKCS11_CKR_UNWRAPPING_KEY_SIZE_RANGE,
    ERROR_IO_PKCS11_CKR_UNWRAPPING_KEY_TYPE_INCONSISTENT,
    ERROR_IO_PKCS11_CKR_USER_ALREADY_LOGGED_IN,
    ERROR_IO_PKCS11_CKR_USER_NOT_LOGGED_IN,
    ERROR_IO_PKCS11_CKR_USER_PIN_NOT_INITIALIZED,
    ERROR_IO_PKCS11_CKR_USER_TYPE_INVALID,
    ERROR_IO_PKCS11_CKR_USER_ANOTHER_ALREADY_LOGGED_IN,
    ERROR_IO_PKCS11_CKR_USER_TOO_MANY_TYPES,
    ERROR_IO_PKCS11_CKR_WRAPPED_KEY_INVALID,
    ERROR_IO_PKCS11_CKR_WRAPPED_KEY_LEN_RANGE,
    ERROR_IO_PKCS11_CKR_WRAPPING_KEY_HANDLE_INVALID,
    ERROR_IO_PKCS11_CKR_WRAPPING_KEY_SIZE_RANGE,
    ERROR_IO_PKCS11_CKR_WRAPPING_KEY_TYPE_INCONSISTENT,
    ERROR_IO_PKCS11_CKR_RANDOM_SEED_NOT_SUPPORTED,
    ERROR_IO_PKCS11_CKR_RANDOM_NO_RNG,
    ERROR_IO_PKCS11_CKR_DOMAIN_PARAMS_INVALID,
    ERROR_IO_PKCS11_CKR_CURVE_NOT_SUPPORTED,
    ERROR_IO_PKCS11_CKR_BUFFER_TOO_SMALL,
    ERROR_IO_PKCS11_CKR_SAVED_STATE_INVALID,
    ERROR_IO_PKCS11_CKR_INFORMATION_SENSITIVE,
    ERROR_IO_PKCS11_CKR_STATE_UNSAVEABLE,
    ERROR_IO_PKCS11_CKR_CRYPTOKI_NOT_INITIALIZED,
    ERROR_IO_PKCS11_CKR_CRYPTOKI_ALREADY_INITIALIZED,
    ERROR_IO_PKCS11_CKR_MUTEX_BAD,
    ERROR_IO_PKCS11_CKR_MUTEX_NOT_LOCKED,
    ERROR_IO_PKCS11_CKR_NEW_PIN_MODE,
    ERROR_IO_PKCS11_CKR_NEXT_OTP,
    ERROR_IO_PKCS11_CKR_EXCEEDED_MAX_ITERATIONS,
    ERROR_IO_PKCS11_CKR_FIPS_SELF_TEST_FAILED,
    ERROR_IO_PKCS11_CKR_LIBRARY_LOAD_FAILED,
    ERROR_IO_PKCS11_CKR_PIN_TOO_WEAK,
    ERROR_IO_PKCS11_CKR_PUBLIC_KEY_INVALID,
    ERROR_IO_PKCS11_CKR_FUNCTION_REJECTED,
    ERROR_IO_PKCS11_ENCODING_ERROR,
    ERROR_IO_TLS_ERROR_DEFAULT_TRUST_STORE_NOT_FOUND,
    ERROR_IO_STREAM_SEEK_UNSUPPORTED,
    ERROR_IO_TLS_ERROR_READ_FAILURE,
    ERROR_IO_PEM_MALFORMED,
    ERROR_IO_SOCKET_MISSING_EVENT_LOOP,
    ERROR_IO_TLS_UNKNOWN_ROOT_CERTIFICATE,
    ERROR_IO_TLS_NO_ROOT_CERTIFICATE_FOUND,
    ERROR_IO_TLS_CERTIFICATE_EXPIRED,
    ERROR_IO_TLS_CERTIFICATE_NOT_YET_VALID,
    ERROR_IO_TLS_BAD_CERTIFICATE,
    ERROR_IO_TLS_PEER_CERTIFICATE_EXPIRED,
    ERROR_IO_TLS_BAD_PEER_CERTIFICATE,
    ERROR_IO_TLS_PEER_CERTIFICATE_REVOKED,
    ERROR_IO_TLS_PEER_CERTIFICATE_UNKNOWN,
    ERROR_IO_TLS_INTERNAL_ERROR,
    ERROR_IO_TLS_CLOSED_GRACEFUL,
    ERROR_IO_TLS_CLOSED_ABORT,
    ERROR_IO_TLS_INVALID_CERTIFICATE_CHAIN,
    ERROR_IO_TLS_HOST_NAME_MISMATCH,
    ERROR_IO_DNS_QUERY_AGAIN,
    ERROR_IO_END_RANGE,
    io_error_code_is_retryable,
    io_error_code_is_tls

using ..ForeignThreads: ForeignThread, ThreadJoinStrategy, managed_thread_finished!, @wrap_thread_fn

include("io.jl")
include("message_pool.jl")

include("apple/kqueue_event_loop_types.jl")
include("linux/epoll_event_loop_types.jl")
include("windows/iocp_event_loop_types.jl")

include("eventloop.jl")
include("apple/kqueue_event_loop.jl")
include("linux/epoll_event_loop.jl")
include("windows/iocp_event_loop.jl")

include("future.jl")

function __init__()
    @static if Sys.isapple() || Sys.isbsd()
        _kqueue_init_cfunctions!()
    elseif Sys.islinux()
        _epoll_init_cfunctions!()
    elseif Sys.iswindows()
        _iocp_init_cfunctions!()
    end
    return nothing
end

export
    EventLoop,
    EventLoopGroup,
    IoEventType,
    with_event_loop_group,
    get_event_loop_group,
    loop_count,
    get_next_event_loop,
    run!,
    stop!,
    wait_for_stop_completion,
    schedule_task_now!,
    schedule_task_now_serialized!,
    schedule_task_future!,
    cancel_task!,
    subscribe_to_io_events!,
    unsubscribe_from_io_events!,
    event_loop_thread_is_callers_thread,
    connect_to_io_completion_port,
    register_tick_start!,
    register_tick_end!,
    load_factor,
    task_sleep_ns,
    task_sleep_s,
    # Futures
    Future,
    cancel!

end # module EventLoops
